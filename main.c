#pragma config(Sensor, S3,     sensRight,      sensorSONAR)
#pragma config(Sensor, S4,     sensHead,       sensorSONAR)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

const short speed = 30;

long lastStepTime;

/*
states:

1 - waiting
2 - running route
3 - cross
*/
short state;


long startTime;
int dt;

float errSum1;
float errSum2;

const int sumTraceS1 = 50.0;
const int sumTraceS2 = 500.0;


const int wallDist = 17;

float sensCum1;
float sensCum2;

const float rightCriteria = 30;


void lineFollow()
{
	switch (state) {
  case 2:

    nxtDisplayTextLine(1, "r = %d", SensorValue[sensRight]);

    float ds = dt * speed;

    sensCum1 = (sensCum1 * (sumTraceS1*log(ds)-1) + SensorValue[sensRight])/(sumTraceS1*log(ds));
    sensCum2 = (sensCum2 * (sumTraceS2*log(ds)-1) + SensorValue[sensRight])/(sumTraceS2*log(ds));

    int summary = (sensCum1>rightCriteria);

    if (summary) {
      state = 1;
    }


		float err = - SensorValue[sensRight] +  wallDist;
		errSum1 = - sensCum1 + wallDist;
		errSum2 = - sensCum2 + wallDist;
		//errSum2 = 0;
		float corr = (err-0.0*errSum2)/30.0+0*(errSum1+0.0*errSum2)*(errSum1+0.0*errSum2)*(errSum1+0.0*errSum2)/10000.0;
		nxtDisplayTextLine(2, "corr = %f", corr);
		nxtDisplayTextLine(3, "sensCum1 = %f", sensCum1);
		nxtDisplayTextLine(4, "sensCum2 = %f", sensCum2);
	  motor[motorB] = speed*(1+corr);
	  motor[motorC] = speed*(1-corr);
	  break;
	default:
	  //should not be in this state
  }
}

void timeInc() {
	if (nSysTime - lastStepTime<10)
	{
		wait1Msec(10);
	}
	dt = nSysTime - lastStepTime;
	lastStepTime += dt;
}

void init() {
  state = 2;
  wait1Msec(500);
  startTime = nSysTime;
  lastStepTime = startTime;
  timeInc();
  sensCum1 = SensorValue[sensRight];
  sensCum2 = SensorValue[sensRight];
}

void printInt(word n)
{
	string s;
	StringFormat(s, "%d", n);
	nxtDisplayTextLine(1,s);
}


task main()
{

  init();
  while(true)
  {
    switch (state)
    {
      case 1:
        motor[motorC] = 0;
        motor[motorB] = 0;
        break;
      case 2:
        lineFollow();
        break;
    }
  }
}
